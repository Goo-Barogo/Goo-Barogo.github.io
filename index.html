<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>영업 관리 시스템 - Ultra Compact</title>

  <style>
    :root {
      --primary: #007AFF;
      --danger: #FF3B30;
      --success: #34C759;
      --warning: #FFD60A;
      --gray: #8E8E93;
      --shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow: hidden; background: #eee; }
    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

    /* 상단 패널 */
    .top-panel {
      position: absolute; top: 0; left: 0; right: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px 16px 16px 16px;
      transform: translateY(-120%);
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 100;
      display: flex; flex-direction: column;
      gap: 8px;
    }
    .top-panel.active { transform: translateY(0); }

    .tp-header { display: flex; justify-content: space-between; align-items: center; }
    .tp-title { font-size: 16px; font-weight: 700; color: #333; }
    .tp-badge { padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .badge-done { background: #ffebee; color: var(--danger); }
    .badge-active { background: #e8f5e9; color: var(--success); }

    /* ✅ 모바일(특히 iOS)에서 인풋 포커스 시 확대 방지: 16px 이상 */
    .tp-memo {
      width: 100%;
      height: 48px;            /* 40->48 (16px 폰트라도 답답하지 않게) */
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      font-size: 16px;         /* ✅ 핵심 */
      line-height: 1.25;
      resize: none;
      outline: none;
      background: #f9f9f9;
      box-sizing: border-box;
      -webkit-text-size-adjust: 100%;
    }

    .tp-actions { display: flex; gap: 6px; }
    .btn {
      flex: 1;
      height: 32px;
      border: none; border-radius: 6px;
      font-weight: 600; font-size: 12px;
      cursor: pointer; color: white; transition: background 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-save { background: var(--primary); }
    .btn-complete { background: var(--primary); }
    .btn-reopen { background: var(--gray); }

    /* 하단 필터바 */
    .bottom-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: white; padding: 12px 16px 24px 16px;
      border-top-left-radius: 16px; border-top-right-radius: 16px;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
      z-index: 90;
      display: flex; gap: 8px;
    }
    select {
      flex: 1; height: 42px; border-radius: 8px; border: 1px solid #ddd;
      padding: 0 10px; font-size: 14px; background: white; outline: none;
    }

    /* 현위치 버튼 */
    .fab-loc {
      position: absolute; right: 16px; bottom: 90px;
      width: 44px; height: 44px; background: white;
      border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border: none; z-index: 90; display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: #333;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .fab-loc.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
    }

    /* 현위치 마커 */
    .loc-marker-wrap {
      position: relative; width: 40px; height: 40px;
      display: flex; justify-content: center; align-items: center;
    }
    .loc-pulse {
      position: absolute; width: 100%; height: 100%;
      background: rgba(0, 122, 255, 0.3);
      border-radius: 50%;
      animation: pulse-ring 2s infinite;
      z-index: 1;
    }
    @keyframes pulse-ring {
      0% { transform: scale(0.5); opacity: 0.8; }
      100% { transform: scale(1.2); opacity: 0; }
    }
    .loc-body-group {
      position: relative; display: flex; flex-direction: column; align-items: center; z-index: 10;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
    }
    .loc-arrow {
      width: 0; height: 0;
      border-left: 5px solid transparent; border-right: 5px solid transparent;
      border-bottom: 8px solid var(--primary); margin-bottom: -3px;
    }
    .loc-circle {
      width: 14px; height: 14px; background: var(--primary);
      border: 2px solid white; border-radius: 50%;
    }

    /* ✅ 상단 토스트 */
    .toast {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(20, 20, 20, 0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 9999;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .toast.success { background: rgba(52, 199, 89, 0.95); }
    .toast.error { background: rgba(255, 59, 48, 0.95); }
    .toast.info { background: rgba(20, 20, 20, 0.92); }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=07f4314a856280075f28a238f072b1c5&libraries=services"></script>
</head>
<body>

  <div id="map"></div>

  <div id="topPanel" class="top-panel">
    <div class="tp-header">
      <span id="tpName" class="tp-title">상점명</span>
      <span id="tpStatus" class="tp-badge badge-active">미영업</span>
    </div>
    <textarea id="tpMemo" class="tp-memo" placeholder="메모를 입력하세요"></textarea>
    <div class="tp-actions">
      <button id="btnToggle" class="btn btn-complete">영업 완료</button>
      <button id="btnSave" class="btn btn-save">메모 저장</button>
    </div>
  </div>

  <div class="bottom-bar">
    <select id="sidoSelect"><option value="">시/도</option></select>
    <select id="sigunguSelect"><option value="">시/군/구</option></select>
  </div>

  <button id="myLocBtn" class="fab-loc">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
    </svg>
  </button>

  <!-- ✅ 토스트 -->
  <div id="toast" class="toast info"></div>

<script>
  const SUPABASE_URL = 'https://dhiyzqyrvivnwbotunjh.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_vSBgIqGFbjm8I9kZ_46EdA_uAkcfn2x';
  const CSV_URL = 'data.csv';

  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let map, geocoder;
  let allData = [], markers = [];
  let geoCache = JSON.parse(localStorage.getItem('GEO_CACHE_V3') || '{}');
  let myLocOverlay = null, watchId = null;
  let selectedStore = null;

  const SVG_PIN_PATH = "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z";
  const SVG_MEMO_BADGE = '<circle cx="19" cy="5" r="4" fill="#FFD60A" stroke="white" stroke-width="1"/>';

  const PIN_BLUE = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36"><path fill="#007AFF" d="${SVG_PIN_PATH}"/><circle cx="12" cy="9" r="3" fill="white"/></svg>`);
  const PIN_BLUE_MEMO = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36"><path fill="#007AFF" d="${SVG_PIN_PATH}"/><circle cx="12" cy="9" r="3" fill="white"/>${SVG_MEMO_BADGE}</svg>`);
  const PIN_RED = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36"><path fill="#FF3B30" d="${SVG_PIN_PATH}"/><circle cx="12" cy="9" r="3" fill="white"/></svg>`);
  const PIN_RED_MEMO = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36"><path fill="#FF3B30" d="${SVG_PIN_PATH}"/><circle cx="12" cy="9" r="3" fill="white"/>${SVG_MEMO_BADGE}</svg>`);

  // ✅ 토스트 유틸
  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function showToast(message, type = 'info', ms = 1200) {
    if (toastTimer) clearTimeout(toastTimer);
    toastEl.textContent = message;
    toastEl.className = `toast show ${type}`;
    toastTimer = setTimeout(() => {
      toastEl.className = `toast ${type}`;
    }, ms);
  }

  async function init() {
    const mapContainer = document.getElementById('map');
    map = new kakao.maps.Map(mapContainer, {
      center: new kakao.maps.LatLng(37.5668, 126.9786),
      level: 5
    });
    geocoder = new kakao.maps.services.Geocoder();

    kakao.maps.event.addListener(map, 'click', () => closeTopPanel());

    await loadData();
  }

  async function loadData() {
    try {
      const [csvResp, dbResp] = await Promise.all([
        fetch(CSV_URL),
        _supabase.from('kakaomap_sales').select('*')
      ]);

      const csvText = await csvResp.text();
      const csvRows = parseCSV(csvText);

      const dbMap = {};
      (dbResp.data || []).forEach(row => dbMap[row.key] = row);

      allData = csvRows.map(row => {
        const key = `${row['상호명']}_${row['사업자주소']}`;
        const dbItem = dbMap[key] || { isSaleDone: false, memo: "" };
        return {
          key,
          name: row['상호명'],
          addr: row['사업자주소'],
          sido: row.psSido,
          sigungu: row.psSigungu,
          lat: parseFloat(row['위도']),
          lng: parseFloat(row['경도']),
          isSaleDone: !!dbItem.isSaleDone,
          memo: dbItem.memo || ""
        };
      }).filter(d => d.sido);

      setupFilters();
    } catch (e) {
      console.error("데이터 로드 실패", e);
      showToast("데이터 로드 실패", "error", 1800);
    }
  }

  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim());

    return lines.slice(1).map(line => {
      let values = [], cur = '', q = false;
      for (let c of line) {
        if (c === '"') q = !q;
        else if (c === ',' && !q) { values.push(cur.trim()); cur = ''; }
        else cur += c;
      }
      values.push(cur.trim());

      const row = {};
      headers.forEach((h, i) => row[h] = values[i] || "");

      const addrParts = (row['사업자주소'] || "").split(" ");
      row.psSido = addrParts[0] || "";
      row.psSigungu = addrParts[1] || "";
      return row;
    });
  }

  function setupFilters() {
    const sidoEl = document.getElementById('sidoSelect');
    const sigunguEl = document.getElementById('sigunguSelect');

    const sidos = [...new Set(allData.map(d => d.sido))].sort();
    sidos.forEach(s => sidoEl.add(new Option(s, s)));

    sidoEl.onchange = () => {
      sigunguEl.innerHTML = '<option value="">시/군/구</option>';
      if (!sidoEl.value) return;
      const filtered = allData.filter(d => d.sido === sidoEl.value);
      const sigungus = [...new Set(filtered.map(d => d.sigungu))].sort();
      sigungus.forEach(sg => sigunguEl.add(new Option(sg, sg)));
    };

    // ✅ 필터 변경 시에는 전체 bounds 맞춤
    sigunguEl.onchange = () => drawMarkers({ fitBounds: true });
  }

  async function drawMarkers({ fitBounds = true } = {}) {
    markers.forEach(m => m.setMap(null));
    markers = [];
    closeTopPanel();

    const sido = document.getElementById('sidoSelect').value;
    const sigungu = document.getElementById('sigunguSelect').value;
    if (!sido || !sigungu) return;

    // ✅ 현재 화면 저장 (fitBounds=false일 때 복원)
    const prevCenter = map.getCenter();
    const prevLevel = map.getLevel();

    const targetData = allData.filter(d => d.sido === sido && d.sigungu === sigungu);
    const bounds = new kakao.maps.LatLngBounds();

    for (const item of targetData) {
      const pos = await getCoords(item);
      if (!pos) continue;

      const hasMemo = item.memo && item.memo.trim().length > 0;
      let svgData = PIN_BLUE;

      if (item.isSaleDone) svgData = hasMemo ? PIN_RED_MEMO : PIN_RED;
      else svgData = hasMemo ? PIN_BLUE_MEMO : PIN_BLUE;

      const markerImage = new kakao.maps.MarkerImage(
        `data:image/svg+xml;charset=utf-8,${svgData}`,
        new kakao.maps.Size(32, 48),
        { offset: new kakao.maps.Point(16, 48) }
      );

      const marker = new kakao.maps.Marker({
        position: pos,
        map: map,
        clickable: true,
        image: markerImage
      });

      kakao.maps.event.addListener(marker, 'click', () => openTopPanel(item, pos));

      markers.push(marker);
      bounds.extend(pos);
    }

    if (fitBounds) {
      if (!bounds.isEmpty()) map.setBounds(bounds);
    } else {
      // ✅ 뱃지 갱신용 재렌더: 기존 시야 유지
      map.setLevel(prevLevel, { animate: false });
      map.setCenter(prevCenter);
    }
  }

  async function getCoords(item) {
    if (item.lat > 30 && item.lng > 120) return new kakao.maps.LatLng(item.lat, item.lng);
    if (geoCache[item.addr]) return new kakao.maps.LatLng(geoCache[item.addr].lat, geoCache[item.addr].lng);

    return new Promise(resolve => {
      geocoder.addressSearch(item.addr, (res, status) => {
        if (status === kakao.maps.services.Status.OK) {
          const lat = parseFloat(res[0].y), lng = parseFloat(res[0].x);
          geoCache[item.addr] = { lat, lng };
          localStorage.setItem('GEO_CACHE_V3', JSON.stringify(geoCache));
          resolve(new kakao.maps.LatLng(lat, lng));
        } else resolve(null);
      });
    });
  }

  function openTopPanel(item, pos) {
    selectedStore = item;
    document.getElementById('tpName').innerText = item.name;
    document.getElementById('tpMemo').value = item.memo;
    updateUIState(item);

    document.getElementById('topPanel').classList.add('active');
    map.panTo(pos);
  }

  function updateUIState(item) {
    const badge = document.getElementById('tpStatus');
    const toggleBtn = document.getElementById('btnToggle');

    if (item.isSaleDone) {
      badge.innerText = "영업 완료";
      badge.className = "tp-badge badge-done";
      toggleBtn.innerText = "영업 취소";
      toggleBtn.className = "btn btn-reopen";
    } else {
      badge.innerText = "미영업";
      badge.className = "tp-badge badge-active";
      toggleBtn.innerText = "영업 완료";
      toggleBtn.className = "btn btn-complete";
    }
  }

  function closeTopPanel() {
    document.getElementById('topPanel').classList.remove('active');
    selectedStore = null;
  }

  document.getElementById('btnSave').onclick = async () => {
    if (!selectedStore) return;
    const memo = document.getElementById('tpMemo').value;

    const ok = await updateDB(selectedStore.key, memo, selectedStore.isSaleDone);
    if (!ok) return;

    // ✅ 화면 유지하면서 마커 뱃지 갱신
    await drawMarkers({ fitBounds: false });

    showToast("메모가 저장되었습니다.", "success");
  };

  document.getElementById('btnToggle').onclick = async () => {
    if (!selectedStore) return;
    const memo = document.getElementById('tpMemo').value;
    const nextStatus = !selectedStore.isSaleDone;

    const ok = await updateDB(selectedStore.key, memo, nextStatus);
    if (!ok) return;

    selectedStore.isSaleDone = nextStatus;
    selectedStore.memo = memo;

    updateUIState(selectedStore);

    // ✅ 화면 유지하면서 마커 뱃지 갱신
    await drawMarkers({ fitBounds: false });

    showToast(nextStatus ? "영업 완료 처리되었습니다." : "영업 취소 처리되었습니다.", "success");
  };

  async function updateDB(key, memo, isSaleDone) {
    const { error } = await _supabase.from('kakaomap_sales').upsert({
      key: key,
      memo: memo,
      isSaleDone: isSaleDone
    }, { onConflict: 'key' });

    if (!error) {
      const target = allData.find(d => d.key === key);
      if (target) { target.memo = memo; target.isSaleDone = isSaleDone; }
      return true;
    } else {
      showToast("DB 저장 실패: " + error.message, "error", 2000);
      return false;
    }
  }

  document.getElementById('myLocBtn').onclick = function() {
    const btn = this;

    if (watchId) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      if (myLocOverlay) myLocOverlay.setMap(null);
      btn.classList.remove('active');
      showToast("현위치 추적 종료", "info");
      return;
    }

    if (navigator.geolocation) {
      btn.classList.add('active');
      showToast("현위치 추적 시작", "info");

      watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const loc = new kakao.maps.LatLng(lat, lng);

        const content = `
          <div class="loc-marker-wrap">
            <div class="loc-pulse"></div>
            <div class="loc-body-group">
              <div class="loc-arrow"></div>
              <div class="loc-circle"></div>
            </div>
          </div>
        `;

        map.setLevel(1, { animate: true });

        if (!myLocOverlay) {
          myLocOverlay = new kakao.maps.CustomOverlay({
            map: map, position: loc, content: content, yAnchor: 0.5, zIndex: 999
          });
        } else {
          myLocOverlay.setMap(map);
          myLocOverlay.setPosition(loc);
        }
        map.panTo(loc);
      }, err => {
        showToast("위치 접근 권한이 필요합니다.", "error", 2000);
        btn.classList.remove('active');
      }, { enableHighAccuracy: true });
    } else {
      showToast("이 브라우저는 위치 기능을 지원하지 않습니다.", "error", 2000);
    }
  };

  init();
</script>
</body>
</html>